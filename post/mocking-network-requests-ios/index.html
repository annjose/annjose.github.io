<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A simple Swift framework for mocking network requests">
  <meta name="generator" content="Hugo 0.30.2" />

  <title>How To Mock Network Requests in iOS &middot; Reflections</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://ann.chiramattel.com/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://ann.chiramattel.com/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://ann.chiramattel.com/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://ann.chiramattel.com/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://ann.chiramattel.com/">Reflections</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://ann.chiramattel.com/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://ann.chiramattel.com/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://ann.chiramattel.com/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/annjose" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/annjose" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/annjose" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://stackoverflow.com/users/402100" target="_blank"><i class="fa fa-stack-overflow fa-fw"></i>Stack Overflow</a>
    </li>
    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>How To Mock Network Requests in iOS</h1>
  <h2>A simple Swift framework for mocking network requests</h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>17 Nov 2018, 19:00</time>
  </div>

  

  
  
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://ann.chiramattel.com/tags/ios">ios</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://ann.chiramattel.com/tags/unit-testing">unit testing</a>
    
  </div>
  
  

</div>

  

<p>One of the challenges of mobile application development is to ensure that the application is resilient to various error responses from the services that are consumed by the application. Mobile devices are more susceptible to network connectivity issues, timeout etc. So we need to take extra care to make sure that we test all error scenarios and handle them in a meaningful manner.</p>

<h2 id="what-and-why-of-mocking">What and Why of Mocking</h2>

<p>Even though we are convinced about the benefits of testing server errors, these services are running in Production serving real customer requests. So it is not possible to make every service API to return these various error responses. So in order to test these scenarios, we need to simulate the server requests locally such that it returns the responses that we want to test. This is what we mean by mocking data requests. These &ldquo;server&rdquo; requests will not actually hit the network; the mocking code runs locally and returns the data that corresponds to success or error response.</p>

<h2 id="so-how-do-we-mock">So How Do We Mock</h2>

<p>Yes. The question is how do we mock these network requests. There are a lot of frameworks and libraries that implement mocking extensions for the iOS networking stack. One such framework I found really interesting is <a href="https://github.com/WeTransfer/Mocker">Mocker</a>.</p>

<h2 id="let-s-meet-mocker">Let&rsquo;s Meet Mocker</h2>

<p>Mocker is a very simple Swift framework that allows us to mock all network calls that are initiated through URLSession(dataTask:) or AlamoFire. I love this library because not only was it easy to get started, but it also supports different use cases like handling server redirects. More importantly, the code is really simple and easy to understand, so we can modify or extend the library as needed.</p>

<p><code>Mocker</code> can be integrated using any of the standard tools like Cocoapods, Carthage or manually as a framework. The installation steps are pretty straight-forward and very well described in the <a href="https://github.com/WeTransfer/Mocker#installation">README of Mocker</a>.</p>

<p>The more interesting exercise would be to look under the hood and understand how it works.</p>

<h2 id="mocker-under-the-hood">Mocker Under The Hood</h2>

<p>The Mocker library is a very light-weight library with just a handful of classes - <code>Mocker</code>, <code>Mock</code> and <code>MockingURLProtocol</code>.</p>

<ul>
<li><p><code>Mock</code> is a simple struct that holds the data that is configured by the test. This includes the URL of the server endpoint,
HTTP method, response data etc.</p></li>

<li><p><code>Mocker</code> is the class where the mocks can be registered and it holds a reference to the mocks and serve them
to the tests as needed. Mocker is held as a singleton instance so that other classes can easily use it.</p></li>

<li><p>MockingURLProtocol is the main class where the real magic of mocking happens.
This class extends the standard <code>URLProtocol</code> class and overrides methods like <code>startLoading</code>, <code>canInit</code>, <code>canonicalRequest</code> etc.
to provide a custom implementation based on mocked data. These methods are called during the life cycle of
<code>URLSession(dataTask:)</code> method and thus can be used to inject custom behavior and mock data to return to the caller.</p></li>
</ul>

<h2 id="how-does-it-work">How Does It Work</h2>

<p>The implementation of <code>startLoading</code> method asks the singleton instance of <code>Mocker</code> to give the instance of <code>Mock</code> that
corresponds to the current <code>request</code> object if registered by the test class. The <code>startLoading</code> method checks the validity
of the <code>Mock</code> instance and completes the request by calling either the method <code>URLProtocolClient(didFinishLoading:)</code>
if the mock is valid or the method <code>URLProtocolClient(didFailWithError:)</code> if the mock is nil or invalid.</p>

<p>As a result, <code>URLSession(dataTask:)</code> returns with a valid mocked data as requested by the test method.</p>

<h2 id="sample-code">Sample Code</h2>

<p>Let&rsquo;s see a few examples of mocking server responses - as success and error - using Mocker library</p>

<h3 id="example-of-success-response">Example of Success Response</h3>

<p>The following test method is using Mocker to mock the scenario of server returning a success
response for the API <code>https://my.service.com/users/me</code></p>

<pre><code>func test_fetch_user_data_success() {
    let serviceUrl = URL(string: &quot;https://my.service.com/users/me&quot;)!

    let responseFile = &quot;Resources/users-api-response-success&quot;
    guard let mockResponse = dataFromTestBundleFile(fileName: responseFile, 
                                                withExtension: &quot;json&quot;) else {
        return
    }
    // The contents of the above file is simple JSON like this: { &quot;name&quot;: &quot;Ann&quot; }
    
    // Set up the mock to return the test data gathered above
    let mockService = Mock(url: serviceUrl, 
                           dataType: Mock.DataType.json, 
                           statusCode: 200, 
                           data: [Mock.HTTPMethod.get : mockResponse])
    mockService.register()
    
    let exp = expectation(description: &quot;expecting to get success response&quot;)
    
    let dataTask = URLSession.shared.dataTask(with: serviceUrl) { 
                            (data, _, error) in
        XCTAssertNil(error)
        
        guard let dataDict = self.verifyAndConvertToDictionary(data: data) else {
            exp.fulfill()
            return
        }

        XCTAssertEqual(dataDict[&quot;name&quot;] as? String, &quot;Ann&quot;)
        exp.fulfill()
    }
    dataTask.resume()
    
    waitForExpectations(timeout: 2.0, handler: nil)
}
</code></pre>

<p>You can see the full code of this test at <a href="https://github.com/annjose/my-learnings/blob/7b6fe8686cadb40c64319766d59ddfe95db1a7b2/URLSessionMockerSample/URLSessionMockerSampleTests/URLSessionMockerSampleTests.swift#L24">URLSessionMockerSampleTests.swift</a>.</p>

<h3 id="examples-of-error-response">Examples of Error Response</h3>

<p>You can follow the above approach to mock error response from the server. Here are a few examples:</p>

<pre><code>// Set up the mock to return HTTP Error code 401
let mockService = Mock(url: serviceUrl, dataType: Mock.DataType.json, 
                        statusCode: 401, data: [Mock.HTTPMethod.get: emptyData])
mockService.register()

let exp = expectation(description: &quot;exp&quot;)

let dataTask = URLSession.shared.dataTask(with: serviceUrl) { 
                        (data, response, _) in
    XCTAssertNotNil(response as? HTTPURLResponse)
    guard let httpResponse = response as? HTTPURLResponse else {
        return
    }
    XCTAssertEqual(httpResponse.statusCode, 401)
    XCTAssertNotNil(data)

    exp.fulfill()
    
}
dataTask.resume()
</code></pre>

<p>See the full code of this test at <a href="https://github.com/annjose/my-learnings/blob/7b6fe8686cadb40c64319766d59ddfe95db1a7b2/URLSessionMockerSample/URLSessionMockerSampleTests/URLSessionMockerSampleTests.swift#L58">URLSessionMockerSampleTests.swift</a>.</p>

<p>Here is a test that mocks an error response with HTTP code 200, but error details are sent in the response body -
 <a href="https://github.com/annjose/my-learnings/blob/7b6fe8686cadb40c64319766d59ddfe95db1a7b2/URLSessionMockerSample/URLSessionMockerSampleTests/URLSessionMockerSampleTests.swift#L93">test_fetch_user_data_error_unauthorized</a>.</p>

<h2 id="what-s-next">What&rsquo;s Next</h2>

<p>Hope this article helped you get started and get a sense of how it will be useful for you. So the best thing to do next
would be to write a simple test and try it out for yourself. You can use this sample project itself or the sample tests
in the <a href="https://github.com/WeTransfer/Mocker">Mocker github repository</a>.</p>

<p>Enjoy mocking testing!</p>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://ann.chiramattel.com/post/swift42-whats-new/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://ann.chiramattel.com/post/swift42-whats-new/">Swift 4.2 - What&#39;s New</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'anncjose';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>

</div>
</div>
<script src="https://ann.chiramattel.com/js/ui.js"></script>
<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75357261-1', 'auto');
  ga('send', 'pageview');

</script>



</body>
</html>

